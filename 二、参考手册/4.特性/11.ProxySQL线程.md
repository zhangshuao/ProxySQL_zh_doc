# ProxySQL 线程

## Main thread 主线程

    ProxySQL是一个多线程守护程序，每个模块有一个或多个线程。主线程只负责引导核心模块和启动其他核心线程。

## Admin thread 管理线程

    此线程负责以下操作：
    * 它初始化并引导管理接口
    * 它从配置文件或数据库文件执行配置的初始加载
    * 如果启用，它将启动处理web UI的HTTP服务器
    * 如果启用，它将配置群集模块
    * 它启动一个监听器，负责接受管理接口中的新连接，并为每个管理/统计连接创建一个新线程

## MySQL workers 工作者

    mysql-threads线程负责处理所有mysql流量、所有客户端连接和所有后端连接。也就是说：一些线程正在处理任意数量的连接。
    
    MySQL工作线程都在同一个端口上监听。当新客户端连接时，其中一个MySQL工作进程将成功接受连接并创建一个MySQL会话：该MySQL会话/客户端将绑定到该特定工作进程，直到客户端断开连接。
    换句话说，客户端连接总是由同一个MySQL工作者处理。
    
## MySQL auxiliary threads辅助线程

    这些线程也称为"空闲线程"。
    
    如果使用--idle-threads选项启动proxysql，则每个MySQL工作线程都会启动一个辅助线程。
    每个MySQL工作线程及其辅助线程一起工作：第一个线程处理活动连接并将所有空闲连接分配给第二个线程，而第二个线程只等待空闲连接上发生事件（或超时），
    并在发生这种情况时将其传回第一个线程。

    当活动客户端连接的数量与空闲客户端连接的数量相比非常少时，建议使用"空闲线程"。
    
    这使ProxySQL能够处理数十万个连接（测试的连接多达一百万个）。

## HTTP server (new in 1.4.4)

    ProxySQL有一个内置的HTTP服务器，它使用libmicrohttpd。
    它配置了MHD_USE_INTERNAL_POLLING_THREAD，因此它可能使用多个线程。
    
## Cluster threads 集群线程 (new in 1.4.2)

    对于ProxySQL集群中的每个ProxySQL节点，都会启动一个线程，并且只负责该对等节点。
    如果添加或删除节点，线程的数量可以动态增加或减少。
    
## Query Cache查询缓存清除线程

    此线程充当查询缓存的垃圾收集器。垃圾收集器用于确保不在服务路径中执行数据清除（当客户端等待答复时）。
    
## ClickHouse Server thread 线程 (new in 1.4.3)

    如果启用了ClickHouse Server（如果编译了对ClickHouse的支持，并且proxysql是以--clickhouse-server启动的），则此线程负责以下操作：
    * 它初始化ClickHouse模块
    * 它启动一个监听器，负责接受新连接，并为每个要访问ClickHouse的客户端连接创建一个新线程

## SQLite3 Server thread 线程 (new in 1.4.3)

    如果启用了SQLite3服务器（proxysql以--sqlite3-server启动），则此线程负责以下操作：
    它初始化SQLite3服务器模块
    它启动一个监听器，负责接受新连接，并为每个要访问内置SQLite3服务器的客户端连接创建一个新线程

## Monitor threads 监控线程

    监视器模块启动多个线程。
    实现在过去已经改变，有时减少线程数量，有时增加线程数量。
    在ProxySQL 1.4中，监视器模块启动的线程有：
    
        * 一个主线程负责为每个监视器类别启动一个线程（共5个）
        * 安排连接检查的线程
        * 一个线程调度ping检查
        * 安排只读检查的线程
        * 安排复制延迟检查的线程
        * 线程调度组复制监视
        * 线程池（最初是mysql线程大小的两倍）
    
    线程池负责执行调度线程调度的所有检查和监视。池可以根据监视器队列中的检查数自动增长和收缩。
    同样的线程还负责根据检查结果立即采取行动，如避开节点或重新配置主机组。

# CPU使用说明

    上面列出的线程具有非常不同的CPU使用配置文件。
    一般来说，MySQL工作线程是最繁忙的线程，也是CPU使用率最高的线程。
    尽管它们的CPU使用率非常低，但如果ProxySQL必须检查数百或数千台服务器，则监视器模块可能会大幅增加监视器线程池的大小。
    
